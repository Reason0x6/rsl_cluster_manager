{% extends "clans/base.html" %}

{% block title %}Assign Siege Plan{% endblock %}

{% block content %}
<style>
    /* Applying general styles to the select elements generated by Django. */
    #post-assignment-form select {
        width: 100%;
        background-color: #374151; /* bg-gray-700 */
        border: 1px solid #4b5563; /* border-gray-600 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.5rem 0.75rem;
        color: #d1d5db; /* text-gray-300 */
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    #post-assignment-form select:focus {
        outline: none;
        border-color: #6366f1; /* border-indigo-500 */
        box-shadow: 0 0 0 2px #4f46e5; /* ring-2 ring-indigo-600 */
    }
    #post-assignment-form label {
        color: #9ca3af; /* text-gray-400 */
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        display: block;
    }
</style>

<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8" data-siege-id="{{ siege_plan.id }}">
    <header class="mb-8">
        <h2 class="text-3xl font-bold text-white">Assign Siege Plan: {{ siege_plan.name }}</h2>
    </header>

    <form method="post" id="post-assignment-form">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for field in form %}
                {% if forloop.counter0|divisibleby:2 %}
                <!-- Card Start -->
                <div class="post-card bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col space-y-4">
                    {% widthratio forloop.counter0 2 1 as post_number_base %}
                    <h3 class="text-lg font-semibold text-white -mb-2">Post {{ post_number_base|add:1 }}</h3>
                    <div>
                    <label>Condition Selection</label>
                    {{ field }}
                </div>
                {% else %}
                     <div>
                    {{ field.label_tag }}
                    {{ field }}<br/>
                </div>
                {% endif %}
            
                {% if forloop.counter|divisibleby:2 or forloop.last %}
                </div>
                <!-- Card End -->
                {% endif %}
            {% endfor %}
        </div>

        <div class="mt-8 text-left">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 mr-5 rounded-lg transition-colors duration-200">
                Save Assignments
            </button>
            <a href="{% url 'export_siege_plan' siege_plan.id %}" role="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 inline-block">
                Export
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Lightweight client: populate player dropdowns based on team-choice and show arena-team selects.
    const players = {{ player_data|safe }} || [];
    const teamTypes = {{ team_types|safe }} || [];
    const savedSelectedTeamsRaw = {{ saved_selected_teams|default:'{}'|safe }} || {};
    const savedSelectedTeams = {};
    Object.keys(savedSelectedTeamsRaw).forEach(k => { savedSelectedTeams[String(k)] = savedSelectedTeamsRaw[k]; });

    const playersByTeamType = {};
    players.forEach(p => (p.team_types || []).forEach(tt => { (playersByTeamType[tt] = playersByTeamType[tt] || []).push(p); }));

    function norm(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }

    function populatePlayerDropdown(dropdown, teamType, selectedPlayer){
        if(!dropdown) return;
        const prev = selectedPlayer || dropdown.value || dropdown.dataset.selectedPlayer || '';
        dropdown.innerHTML = '';
        const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='Select a player'; dropdown.appendChild(placeholder);
        if(!teamType){ players.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; if(String(p.id)===String(prev)) o.selected=true; dropdown.appendChild(o); }); }
        else { const tt = teamTypes.find(t=>t[0]===teamType||t[1]===teamType) || [teamType,teamType]; const list = playersByTeamType[tt[0]]||[]; list.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; if(String(p.id)===String(prev)) o.selected=true; dropdown.appendChild(o); }); }
        if(!dropdown.dataset.postNumber){ const name = dropdown.getAttribute('name')||''; const m = name.match(/post_(\d+)_player/); if(m) dropdown.dataset.postNumber=m[1]; const card = dropdown.closest && dropdown.closest('.post-card'); if(card && !dropdown.dataset.postNumber){ const h=card.querySelector('h3'); const mh = h && h.textContent.match(/Post\s*(\d+)/i); if(mh) dropdown.dataset.postNumber=mh[1]; } }
        dropdown.dataset.selectedPlayer = prev || '';
        if(dropdown.value) attachArenaTeamSelector(dropdown.dataset.postNumber, teamType);
    }

    function refreshAllArenaSelectors(){
        // Rebuild arena selectors for all posts so disabled/enabled states update across the page
        Array.from(document.querySelectorAll('.team-choice')).forEach(tc=>{
            const pn = tc.dataset.postNumber || (tc.getAttribute('name')||'').match(/post_(\d+)/)?.[1];
            if(!pn) return;
            attachArenaTeamSelector(pn, tc.value);
        });
    }

    function attachArenaTeamSelector(postNumber, teamType){
        const pn=String(postNumber||'');
        let playerSelect = document.querySelector(`.player-dropdown[data-post-number="${pn}"]`) || document.querySelector(`#post-assignment-form select[name="post_${pn}_player"]`);
        if(!playerSelect){ const card = Array.from(document.querySelectorAll('.post-card')).find(c=> (c.querySelector('h3')||{}).textContent.match(new RegExp('Post\\s*'+pn))); if(card) playerSelect = card.querySelector('.player-dropdown')||card.querySelector('select[name^="post_"]'); }
        if(!playerSelect) return;
        const container = playerSelect.parentElement;
        Array.from(container.querySelectorAll('.arena-team-select, .arena-remove-btn, .arena-status')).forEach(el=>el.remove());
        const sel = document.createElement('select'); sel.className='arena-team-select'; sel.dataset.postNumber=pn; sel.dataset.assignmentId=pn; const ph=document.createElement('option'); ph.value=''; ph.textContent='Select a team'; sel.appendChild(ph);
        const selectedPlayerId = playerSelect.value; if(!selectedPlayerId){ sel.style.display='none'; container.appendChild(sel); return; } sel.style.display='';
        const playerObj = players.find(p=>String(p.id)===String(selectedPlayerId)) || players.find(p=>p.name===selectedPlayerId);
        if(!playerObj || !Array.isArray(playerObj.arena_teams) || playerObj.arena_teams.length===0){ container.appendChild(sel); sel.style.display='none'; return; }
        const wanted = norm(teamType);
        playerObj.arena_teams.forEach(at=>{ const atType = norm(at.team_type||''); if(!teamType || atType===wanted){ const o=document.createElement('option'); o.value=at.id; o.textContent = Array.isArray(at.champions)? at.champions.join(', '): String(at.champions); o.dataset.champions = Array.isArray(at.champions)? at.champions.join('||'): String(at.champions); sel.appendChild(o); } });
        if(sel.options.length<=1){ playerObj.arena_teams.forEach(at=>{ const o=document.createElement('option'); o.value=at.id; o.textContent = Array.isArray(at.champions)? at.champions.join(', '): String(at.champions); o.dataset.champions = Array.isArray(at.champions)? at.champions.join('||'): String(at.champions); sel.appendChild(o); }); }
        try{ const saved = savedSelectedTeams[pn] || savedSelectedTeams[parseInt(pn)]; if(saved){ const opt = Array.from(sel.options).find(o=>o.value===saved); if(opt) sel.value=saved; } }catch(e){}
        container.appendChild(sel); const btn=document.createElement('button'); btn.type='button'; btn.className='arena-remove-btn mt-3 ml-2 bg-red-600 hover:bg-red-700 text-white text-xs py-1 px-2 rounded'; btn.textContent='Remove'; container.appendChild(btn); const status=document.createElement('span'); status.className='arena-status ml-2 text-sm'; container.appendChild(status);
        try{
            // Compute used champions from all other selected teams across posts (not limited to same player)
            const used=new Set();
            Array.from(document.querySelectorAll('.arena-team-select')).forEach(s=>{
                const otherPn = s.dataset.postNumber;
                if(!s.value) return;
                if(otherPn===pn) return;
                const pd = document.querySelector(`.player-dropdown[data-post-number="${otherPn}"]`);
                const pid = pd?pd.value:null;
                if(!pid) return;
                // Only count champions used by the same player as selectedPlayerId
                if(pid !== selectedPlayerId) return;
                const opt = s.options[s.selectedIndex];
                if(opt){ const raw = opt.dataset.champions||''; raw.split('||').map(x=>x.trim()).filter(Boolean).forEach(c=>used.add(c)); }
            });
            Array.from(sel.options).forEach(o=>{ if(!o.value) return; const champs=(o.dataset.champions||'').split('||').map(x=>x.trim()).filter(Boolean); const intersects=champs.some(c=>used.has(c)); o.disabled=(o.value!==sel.value)&&intersects; });
        }catch(e){}
    }

    Array.from(document.querySelectorAll('.team-choice')).forEach(tc=>{ const pn = tc.dataset.postNumber || (tc.getAttribute('name')||'').match(/post_(\d+)/)?.[1]; const dropdown = document.querySelector(`.player-dropdown[data-post-number="${pn}"]`) || document.querySelector(`#post-assignment-form select[name="post_${pn}_player"]`); if(dropdown) dropdown.setAttribute('data-post-number', pn); tc.addEventListener('change', function(){ const p=document.querySelector(`.player-dropdown[data-post-number="${this.dataset.postNumber}"]`) || document.querySelector(`#post-assignment-form select[name="post_${this.dataset.postNumber}_player"]`); if(p) populatePlayerDropdown(p, this.value, null); }); });

    Array.from(document.querySelectorAll('.team-choice')).forEach(tc=>{ const pn = tc.dataset.postNumber || (tc.getAttribute('name')||'').match(/post_(\d+)/)?.[1]; const p = document.querySelector(`.player-dropdown[data-post-number="${pn}"]`) || document.querySelector(`#post-assignment-form select[name="post_${pn}_player"]`); if(p){ p.setAttribute('data-post-number', pn); populatePlayerDropdown(p, tc.value, p.dataset.selectedPlayer); } });

    document.addEventListener('change', function(e){ const t=e.target; if(!t||!t.classList) return; if(t.classList.contains('player-dropdown')){ const pn = t.dataset.postNumber || (t.getAttribute('name')||'').match(/post_(\d+)_player/)?.[1]; const playerUuid = t.value||null; const planId=document.querySelector('[data-siege-id]')?.dataset.siegeId; if(!pn||!planId) return; function getCookie(n){ const v=document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)'); return v? v.pop():''; } const headers={'Content-Type':'application/json','Accept':'application/json'}; const csrftoken=getCookie('csrftoken'); if(csrftoken) headers['X-CSRFToken']=csrftoken; fetch(`/siege-plan/${planId}/assignment/${pn}/set-player/`, { method:'POST', headers, body: JSON.stringify({ player_uuid: playerUuid }), credentials:'same-origin' }).then(r=> r.json().catch(()=>({success:false, error:'invalid-json'}))).then(data=>{ if(data && data.success){ if(data.cleared_selected_arena_team){ delete savedSelectedTeams[String(pn)]; } // refresh this post's arena selector
            attachArenaTeamSelector(pn, (document.querySelector(`.team-choice[data-post-number="${pn}"]`)||{}).value);
            // refresh others to update disabling
            setTimeout(refreshAllArenaSelectors, 10);
        } else { console.error('set-player failed', data); } }).catch(err=>{ console.error('set-player network error', err); }); } });

    document.addEventListener('change', function(e){ const t=e.target; if(!t||!t.classList) return; if(t.classList.contains('arena-team-select')){ const sel=t; const arenaTeamId=sel.value||null; const postNum=sel.dataset.assignmentId||sel.dataset.postNumber; const planId=document.querySelector('[data-siege-id]')?.dataset.siegeId; if(!postNum||!planId) return; function getCookie(n){ const v=document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)'); return v? v.pop():''; } const headers={'Content-Type':'application/json','Accept':'application/json'}; const csrftoken=getCookie('csrftoken'); if(csrftoken) headers['X-CSRFToken']=csrftoken; fetch(`/siege-plan/${planId}/assignment/${postNum}/select-team/`, { method:'POST', headers, body: JSON.stringify({ arena_team_id: arenaTeamId }), credentials:'same-origin' }).then(r=> r.json().catch(()=>({success:false, error:'invalid-json'}))).then(data=>{
            const statusEl = sel.parentElement.querySelector('.arena-status') || (function(){ const s=document.createElement('span'); sel.parentElement.appendChild(s); return s; })();
            if(!data||!data.success){
                statusEl.textContent = data&&data.error? `Error: ${data.error}` : 'Error saving';
                statusEl.className='arena-status text-red-400';
            } else {
                statusEl.textContent = data.cleared? 'Cleared':'Saved';
                statusEl.className='arena-status text-green-400';
                // Update client-side saved state so preselection and refresh use the new value
                try{
                    if(arenaTeamId){ savedSelectedTeams[String(postNum)] = arenaTeamId; }
                    else { delete savedSelectedTeams[String(postNum)]; }
                }catch(_){}
                // Rebuild all arena selectors so enabled/disabled options reflect the new global selections
                try{ setTimeout(refreshAllArenaSelectors, 10); }catch(e){}
                setTimeout(()=>{ try{ statusEl.textContent=''; }catch(e){} },2000);
            }
            try{ const playerEl = document.querySelector(`.player-dropdown[data-post-number="${postNum}"]`) || document.querySelector(`.player-dropdown[name^="post_${postNum}_player"]`); const playerId = playerEl?playerEl.value:null; if(playerId){ document.querySelectorAll('.player-dropdown').forEach(pd=>{ if(pd.value===playerId){ const pn = pd.dataset.postNumber || (pd.getAttribute('name')||'').match(/post_(\d+)_player/)?.[1]; if(pn && pn!==postNum) attachArenaTeamSelector(pn, (document.querySelector(`.team-choice[data-post-number="${pn}"]`)||{}).value); } }); } }catch(e){ console.error(e); }
        }).catch(err=>{ console.error('Save error', err); const statusEl = sel.parentElement.querySelector('.arena-status') || (function(){ const s=document.createElement('span'); sel.parentElement.appendChild(s); return s; })(); statusEl.textContent='Network error'; statusEl.className='arena-status text-red-400'; }); } });

    document.addEventListener('click', function(e){ const t=e.target; if(!t||!t.classList) return; if(t.classList.contains('arena-remove-btn')){ const parent=t.parentElement; const sel=parent.querySelector('.arena-team-select'); if(sel){ sel.value=''; sel.dispatchEvent(new Event('change',{bubbles:true})); } } });
});
</script>

{% endblock %}