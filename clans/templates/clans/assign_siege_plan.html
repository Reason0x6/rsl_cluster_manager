{% extends "clans/base.html" %}

{% block title %}Assign Siege Plan{% endblock %}

{% block content %}
<style>
    /* Applying general styles to the select elements generated by Django.
     For best results, add Tailwind classes directly to the form widgets in your forms.py.
     Example:
     forms.Select(attrs={'class': 'w-full bg-gray-700 border border-gray-600 rounded-lg ...'})
    */
    #post-assignment-form select {
        width: 100%;
        background-color: #374151; /* bg-gray-700 */
        border: 1px solid #4b5563; /* border-gray-600 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.5rem 0.75rem;
        color: #d1d5db; /* text-gray-300 */
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    #post-assignment-form select:focus {
        outline: none;
        border-color: #6366f1; /* border-indigo-500 */
        box-shadow: 0 0 0 2px #4f46e5; /* ring-2 ring-indigo-600 */
    }
    #post-assignment-form label {
        color: #9ca3af; /* text-gray-400 */
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        display: block;
    }
</style>

<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8">
        <h2 class="text-3xl font-bold text-white">Assign Siege Plan: {{ siege_plan.name }}</h2>
    </header>

    <form method="post" id="post-assignment-form">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for field in form %}
                {% if forloop.counter0|divisibleby:2 %}
                <!-- Card Start -->
                <div class="post-card bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col space-y-4">
                    {% widthratio forloop.counter0 2 1 as post_number_base %}
                    <h3 class="text-lg font-semibold text-white -mb-2">Post {{ post_number_base|add:1 }}</h3>
                    <div>
                    <label>Condition Selection</label>
                    {{ field }}
                </div>
                {% else %}
                     <div>
                    {{ field.label_tag }}
                    {{ field }}
                </div>
                {% endif %}
            
                {% if forloop.counter|divisibleby:2 or forloop.last %}
                </div>
                <!-- Card End -->
                {% endif %}
            {% endfor %}
        </div>

        <div class="mt-8 text-left">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200">
                Save Assignments
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // NOTE: This script assumes your Django form fields have the correct classes.
        // Team selection fields should have class="team-choice"
        // Player selection fields should have class="player-dropdown"
        const teamChoiceFields = document.querySelectorAll('.team-choice');
        const playerDropdowns = document.querySelectorAll('.player-dropdown');

        // Player data passed from the server
        const players = {{ player_data|safe }};
        const teamTypes = {{ team_types|safe }};
        
        // Store players by their team types
        const playersByTeamType = {};
        players.forEach(player => {
            player.team_types.forEach(teamType => {
                if (!playersByTeamType[teamType]) {
                    playersByTeamType[teamType] = [];
                }
                playersByTeamType[teamType].push(player);
            });
        });

        // Function to populate a player dropdown
        function populatePlayerDropdown(dropdown, teamType, selectedPlayer) {
            dropdown.innerHTML = '<option value="">Select a player</option>'; // Reset dropdown
            let type = teamTypes.find(t => t[0] === teamType || t[1] === teamType);
            if (!type) {
                // If no team type is selected, show all players
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id; // Use UUID as the value
                    option.textContent = player.name;
                    if (player.id === selectedPlayer) {
                        option.selected = true;
                    }
                    dropdown.appendChild(option);
                });
            } else if (playersByTeamType[type[0]]) {
                // Show players matching the selected team type
                const filteredPlayers = playersByTeamType[type[0]];
                filteredPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id; // Use UUID as the value
                    option.textContent = player.name;
                    if (player.id === selectedPlayer) {
                        option.selected = true;
                    }
                    dropdown.appendChild(option);
                });
            }
        }

        // Initialize player dropdowns on page load
        teamChoiceFields.forEach(field => {
            const postNumber = field.dataset.postNumber;
            const dropdown = document.querySelector(`.player-dropdown[data-post-number="${postNumber}"]`);
            if (dropdown) {
                const selectedTeamType = field.value; // Get the default or pre-selected team type
                const selectedPlayer = dropdown.dataset.selectedPlayer; // Preselected player
                populatePlayerDropdown(dropdown, selectedTeamType, selectedPlayer);
            }
        });

        // Event listener for team choice changes
        teamChoiceFields.forEach(field => {
            field.addEventListener('change', function () {
                const postNumber = this.dataset.postNumber;
                const dropdown = document.querySelector(`.player-dropdown[data-post-number="${postNumber}"]`);
                if(dropdown){
                    const selectedTeamType = this.value;
                    populatePlayerDropdown(dropdown, selectedTeamType, null);
                }
            });
        });
    });
</script>
{% endblock %}
